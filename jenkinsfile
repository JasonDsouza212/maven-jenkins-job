def gv
pipeline{
    agent any 
    tools{
        maven 'maven-3.8'
    }
    stages {
    
        stage("init"){
         steps{
               script{
                gv=load "script.groovy"
            }
         }
        }
        stage("increment-version"){
            steps{
                script{
                    echo "Incrementing Version to next version"
                    sh "mvn build-helper:parse-version versions:set \
                    -DnewVersion=\\\${parsedVersion.majorVersion}.\\\${parsedVersion.minorVersion}.\\\${parsedVersion.nextIncrementalVersion} \
                    versions:commit"
                   def matcher = readFile('pom.xml') =~ '<version>(.+)</version>'
                    def version = matcher[0][1]
                    env.IMAGE_NAME ="$version-$BUILD_NUMBER"
                }
            }
        }
        stage("build jar") {
            steps {
                script {
                    gv.buildJar()
                }
            }
        }
        stage("build image") {
            steps {
                script {
                    gv.buildImage()
                    }
                }
            }
        
        stage("deploy") {
            steps {
                script {
                    gv.buildDeploy()
                   
                }
            }
        }
        stage('commit version update'){
            steps{
                script{
                      withCredentials([usernamePassword(credentialsId: 'github-credentials', passwordVariable:'PASS', usernameVariable: 'USER' )]){
                        sh 'git config --global user.email "jasondsouza212@gmail.com"'
                        sh 'git config --global user.name "jenkins"'
                        
                        sh 'git status'
                        sh 'git branch'
                        sh 'git config --list'
                        
                        sh "git remote set-url origin https://${USER}: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@github.com/JasonDsouza212/maven-jenkins-job-dockerfil.git"
                        sh "git add ."
                        sh 'git commit -m "the new version is added"'
                        sh 'git push origin HEAD:main'
                   }
                }
            }
        }
    }
    }
